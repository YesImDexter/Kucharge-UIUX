<!DOCTYPE html>
<html lang="en" class="h-full">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Active Charging - Kucharge</title>

    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Custom CSS -->
    <link rel="stylesheet" href="style.css">

    <!-- Configure Tailwind for dark mode -->
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        'primary-blue': '#3B82F6',
                        'primary-green': '#10B981',
                    }
                }
            }
        }
    </script>
</head>

<body class="h-full bg-white dark:bg-gray-900 transition-colors duration-300">

    <div class="min-h-full flex items-center justify-center px-4 py-6 sm:px-6 lg:px-8">
        <div class="max-w-md w-full space-y-6">

            <!-- Header with Logo -->
            <div class="text-center">
                <div class="mb-4">
                    <img src="Images/Logo.png" alt="Kucharge" class="h-12 mx-auto">
                </div>
                <p class="mt-1 text-sm text-gray-600 dark:text-gray-400">
                    Charging Session
                </p>
            </div>

            <!-- EV Car Visual with Circular Progress -->
            <div
                class="bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-2xl shadow-2xl p-8 relative">

                <!-- Dark Mode Toggle - Top Right of Container -->
                <div class="absolute top-4 right-4">
                    <button id="dark-mode-toggle" onclick="toggleDarkMode()"
                        class="px-3 py-2 bg-gray-100 dark:bg-gray-700 text-gray-900 dark:text-white border border-gray-300 dark:border-gray-600 rounded-lg shadow-md hover:shadow-lg transition-all duration-300 text-xs font-medium">
                        <span class="text-blue-400">🌙</span> Dark
                    </button>
                </div>

                <div class="text-center mb-6">
                    <h2 class="text-xl font-semibold text-gray-900 dark:text-white mb-2">
                        Charging Progress
                    </h2>
                    <div class="w-16 h-1 bg-gradient-to-r from-blue-600 to-green-600 mx-auto rounded-full"></div>
                </div>

                <!-- Circular Progress Container -->
                <div class="flex justify-center mb-6">
                    <div class="relative">
                        <!-- Circular Progress Ring -->
                        <svg class="w-48 h-48 transform -rotate-90" viewBox="0 0 100 100">
                            <!-- Background circle -->
                            <circle cx="50" cy="50" r="45" stroke="currentColor" stroke-width="4" fill="none"
                                class="text-gray-200 dark:text-gray-700" />
                        </svg>

                        <!-- EV Car Image Container -->
                        <div class="absolute inset-0 flex items-center justify-center">
                            <div
                                class="w-48 h-48 bg-white dark:bg-gray-900 rounded-full flex items-center justify-center shadow-lg border-4 border-gray-200 dark:border-gray-600">
                                <img src="EV-Car.png" alt="EV Car" class="w-48 h-48 object-contain">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Progress Bar -->
                <div class="mb-6">
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-sm font-medium text-gray-600 dark:text-gray-300">Charging Progress</span>
                        <span id="progress-percentage"
                            class="text-sm font-medium text-blue-600 dark:text-blue-400">0%</span>
                    </div>
                    <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-3">
                        <div id="progress-bar"
                            class="bg-gradient-to-r from-blue-500 to-green-500 h-3 rounded-full transition-all duration-1000"
                            style="width: 0%"></div>
                    </div>
                </div>

                <!-- Connection Status -->
                <div class="space-y-3 mb-6">
                    <div class="flex justify-between items-center p-3 bg-gray-50 dark:bg-gray-700 rounded-lg">
                        <span class="text-sm font-medium text-gray-600 dark:text-gray-300">Connected to Car</span>
                        <span id="car-connection-status"
                            class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200">
                            <span class="w-1.5 h-1.5 bg-red-500 rounded-full mr-1.5"></span>
                            Not Connected
                        </span>
                    </div>

                    <div class="flex justify-between items-center p-3 bg-gray-50 dark:bg-gray-700 rounded-lg">
                        <span class="text-sm font-medium text-gray-600 dark:text-gray-300">Charging Status</span>
                        <span id="main-charging-status"
                            class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-200">
                            <span class="w-1.5 h-1.5 bg-yellow-500 rounded-full mr-1.5"></span>
                            Waiting
                        </span>
                    </div>

                    <div class="flex justify-between items-center p-3 bg-gray-50 dark:bg-gray-700 rounded-lg">
                        <span class="text-sm font-medium text-gray-600 dark:text-gray-300">Time Remaining</span>
                        <span id="circular-timer" class="text-lg font-bold text-blue-600 dark:text-blue-400">
                            00:00
                        </span>
                    </div>
                </div>

                <!-- Control Buttons -->
                <div class="space-y-3 mb-6">
                    <!-- Simulation Controls -->
                    <div id="simulation-controls" class="space-y-3">
                        <button id="simulate-plugin-btn" onclick="simulatePlugIn()"
                            class="w-full py-3 px-4 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 transition-colors duration-200 flex items-center justify-center gap-2">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24"
                                fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                stroke-linejoin="round" class="lucide lucide-play-icon lucide-play">
                                <path
                                    d="M5 5a2 2 0 0 1 3.008-1.728l11.997 6.998a2 2 0 0 1 .003 3.458l-12 7A2 2 0 0 1 5 19z" />
                            </svg>
                            Start Transaction
                        </button>

                        <button id="cancel-transaction-btn" onclick="showCancelTransactionModal()"
                            class="w-full py-3 px-4 bg-red-600 text-white font-semibold rounded-lg hover:bg-red-700 transition-colors duration-200 flex items-center justify-center gap-2">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24"
                                fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                stroke-linejoin="round" class="lucide lucide-x-circle">
                                <circle cx="12" cy="12" r="10" />
                                <path d="M15 9l-6 6" />
                                <path d="M9 9l6 6" />
                            </svg>
                            Cancel Transaction
                        </button>
                    </div>

                    <!-- Charging Controls (Hidden by default) -->
                    <div id="charging-controls" class="space-y-3 hidden">
                        <button id="start-charging-btn" onclick="startCharging()"
                            class="w-full py-3 px-4 bg-green-600 text-white font-semibold rounded-lg hover:bg-green-700 transition-colors duration-200 flex items-center justify-center gap-2">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24"
                                fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                stroke-linejoin="round" class="lucide lucide-power-icon lucide-power">
                                <path d="M12 2v10" />
                                <path d="M18.4 6.6a9 9 0 1 1-12.77.04" />
                            </svg>
                            Start Charging
                        </button>

                        <button id="stop-charging-btn" onclick="showStopChargingModal()" disabled
                            class="w-full py-3 px-4 bg-gray-300 dark:bg-gray-600 text-gray-500 dark:text-gray-400 font-semibold rounded-lg cursor-not-allowed transition-all duration-200 flex items-center justify-center gap-2">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24"
                                fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                stroke-linejoin="round" class="lucide lucide-octagon-minus-icon lucide-octagon-minus">
                                <path
                                    d="M2.586 16.726A2 2 0 0 1 2 15.312V8.688a2 2 0 0 1 .586-1.414l4.688-4.688A2 2 0 0 1 8.688 2h6.624a2 2 0 0 1 1.414.586l4.688 4.688A2 2 0 0 1 22 8.688v6.624a2 2 0 0 1-.586 1.414l-4.688 4.688a2 2 0 0 1-1.414.586H8.688a2 2 0 0 1-1.414-.586z" />
                                <path d="M8 12h8" />
                            </svg>
                            Stop Charging
                        </button>
                    </div>
                </div>
            </div>

            <!-- Charger Session Details Card -->
            <div
                class="bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-2xl shadow-2xl p-6">
                <div class="text-center mb-6">
                    <h2 class="text-xl font-semibold text-gray-900 dark:text-white mb-2">
                        Session Details
                    </h2>
                    <div class="w-16 h-1 bg-gradient-to-r from-blue-600 to-green-600 mx-auto rounded-full"></div>
                </div>

                <!-- Session Details -->
                <div class="space-y-4 mb-6">
                    <div class="flex justify-between items-center p-3 bg-gray-50 dark:bg-gray-700 rounded-lg">
                        <span class="text-sm font-medium text-gray-600 dark:text-gray-300">Charger ID</span>
                        <span id="active-charger-id"
                            class="text-sm font-bold text-gray-900 dark:text-white">Loading...</span>
                    </div>

                    <div class="flex justify-between items-center p-3 bg-gray-50 dark:bg-gray-700 rounded-lg">
                        <span class="text-sm font-medium text-gray-600 dark:text-gray-300">Amount Paid</span>
                        <span id="active-amount" class="text-lg font-bold text-green-600 dark:text-green-400">RM
                            0.00</span>
                    </div>

                    <div class="flex justify-between items-center p-3 bg-blue-50 dark:bg-blue-900/20 rounded-lg">
                        <span class="text-sm font-medium text-blue-700 dark:text-blue-300">Total Duration</span>
                        <span id="total-duration"
                            class="text-lg font-bold text-blue-600 dark:text-blue-400">00:00</span>
                    </div>
                </div>
            </div>







            <!-- Plug-In Modal -->
            <div id="plugin-modal"
                class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
                <div class="bg-white dark:bg-gray-800 rounded-2xl p-8 max-w-sm w-full mx-4 text-center">
                    <div class="mb-6">
                        <div
                            class="w-16 h-16 bg-blue-100 dark:bg-blue-900/20 rounded-full flex items-center justify-center mx-auto mb-4">
                            <span class="scale-105 text-white"><svg xmlns="http://www.w3.org/2000/svg" width="24"
                                    height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                                    stroke-linecap="round" stroke-linejoin="round"
                                    class="lucide lucide-plug-zap-icon lucide-plug-zap">
                                    <path d="M6.3 20.3a2.4 2.4 0 0 0 3.4 0L12 18l-6-6-2.3 2.3a2.4 2.4 0 0 0 0 3.4Z" />
                                    <path d="m2 22 3-3" />
                                    <path d="M7.5 13.5 10 11" />
                                    <path d="M10.5 16.5 13 14" />
                                    <path d="m18 3-4 4h6l-4 4" />
                                </svg></span>
                        </div>
                        <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-2">
                            Connect Charger
                        </h3>
                        <p class="text-sm text-gray-600 dark:text-gray-300">
                            Please plug in the charger to start charging.
                        </p>
                    </div>
                    <button onclick="closePluginModal()"
                        class="w-full py-3 px-4 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 transition-colors duration-200">
                        Got it!
                    </button>
                </div>
            </div>

            <!-- Debugger Modal -->
            <div id="debugger-modal"
                class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
                <div class="bg-white dark:bg-gray-800 rounded-2xl p-8 max-w-sm w-full mx-4 text-center relative">
                    <!-- Close Button -->
                    <button onclick="closeDebuggerModal()"
                        class="absolute top-4 right-4 w-8 h-8 bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 rounded-full flex items-center justify-center transition-colors duration-200">
                        <span class="text-gray-600 dark:text-gray-300 text-lg font-bold">×</span>
                    </button>

                    <div class="mb-6">
                        <div
                            class="w-16 h-16 bg-red-100 dark:bg-red-900/20 rounded-full flex items-center justify-center mx-auto mb-4">
                            <span class="text-4xl text-white"><svg xmlns="http://www.w3.org/2000/svg" width="24"
                                    height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                                    stroke-linecap="round" stroke-linejoin="round"
                                    class="lucide lucide-bug-play-icon lucide-bug-play">
                                    <path d="M10 19.655A6 6 0 0 1 6 14v-3a4 4 0 0 1 4-4h4a4 4 0 0 1 4 3.97" />
                                    <path
                                        d="M14 15.003a1 1 0 0 1 1.517-.859l4.997 2.997a1 1 0 0 1 0 1.718l-4.997 2.997a1 1 0 0 1-1.517-.86z" />
                                    <path d="M14.12 3.88 16 2" />
                                    <path d="M20.97 5c0 2.1-1.6 3.8-3.5 4" />
                                    <path d="M3 21c0-2.1 1.7-3.9 3.8-4" />
                                    <path d="M6 13H2" />
                                    <path d="M6.53 9C4.6 8.8 3 7.1 3 5" />
                                    <path d="m8 2 1.88 1.88" />
                                    <path d="M9 7.13v-1a3 3 0 0 1 4.18-2.895 3 3 0 0 1 1.821 2.896v1" />
                                </svg></span>
                        </div>
                        <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">
                            Debug Controls
                        </h3>
                        <p class="text-sm text-gray-600 dark:text-gray-300 mb-6">
                            Developer tools for testing charging functionality.
                        </p>

                        <!-- Charger Connection Toggle -->
                        <div class="mb-6 p-4 bg-gray-50 dark:bg-gray-700 rounded-lg">
                            <div class="flex items-center justify-between">
                                <span class="text-sm font-medium text-gray-700 dark:text-gray-300">Is Charger
                                    Connected?</span>
                                <button id="charger-toggle" onclick="toggleChargerConnection()"
                                    class="relative inline-flex h-6 w-11 items-center rounded-full bg-gray-200 dark:bg-gray-600 transition-colors duration-200">
                                    <span id="toggle-circle"
                                        class="inline-block h-4 w-4 transform rounded-full bg-white transition-transform duration-200 translate-x-1"></span>
                                </button>
                            </div>
                        </div>

                        <div class="space-y-3">
                            <button onclick="completeChargeSimulate()"
                                class="w-full py-3 px-4 bg-green-600 text-white font-semibold rounded-lg hover:bg-green-700 transition-colors duration-200">
                                Complete Charge Simulate
                            </button>
                            <button onclick="closeDebuggerModal()"
                                class="w-full py-3 px-4 bg-gray-600 text-white font-semibold rounded-lg hover:bg-gray-700 transition-colors duration-200">
                                Close
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Stop Charging Modal -->
            <div id="stop-charging-modal"
                class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
                <div class="bg-white dark:bg-gray-800 rounded-2xl p-8 max-w-sm w-full mx-4 text-center">
                    <div class="mb-6">
                        <div
                            class="w-16 h-16 bg-red-100 dark:bg-red-900/20 rounded-full flex items-center justify-center mx-auto mb-4">
                            <span class="text-3xl">⚠️</span>
                        </div>
                        <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">
                            Stop Charging?
                        </h3>
                        <p class="text-sm text-gray-600 dark:text-gray-300 mb-6">
                            Stopping charging will end your session and complete the transaction. Any unused funds will
                            be refunded back to your account.
                        </p>

                        <div class="space-y-3">
                            <button onclick="confirmStopCharging()"
                                class="w-full py-3 px-4 bg-red-600 text-white font-semibold rounded-lg hover:bg-red-700 transition-colors duration-200">
                                Yes, Stop Charging
                            </button>
                            <button onclick="closeStopChargingModal()"
                                class="w-full py-3 px-4 bg-gray-600 text-white font-semibold rounded-lg hover:bg-gray-700 transition-colors duration-200">
                                Cancel
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Cancel Transaction Modal -->
            <div id="cancel-transaction-modal"
                class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
                <div class="bg-white dark:bg-gray-800 rounded-2xl p-8 max-w-sm w-full mx-4 text-center">
                    <div class="mb-6">
                        <div
                            class="w-16 h-16 bg-orange-100 dark:bg-orange-900/20 rounded-full flex items-center justify-center mx-auto mb-4">
                            <span class="text-3xl">❌</span>
                        </div>
                        <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">
                            Cancel Transaction?
                        </h3>
                        <p class="text-sm text-gray-600 dark:text-gray-300 mb-6">
                            This will cancel your current transaction and return you to the home page. Your payment of
                            <strong>RM <span id="cancel-amount">0.00</span></strong> will be refunded within 3-5
                            business days.
                        </p>

                        <div class="space-y-3">
                            <button onclick="confirmCancelTransaction()"
                                class="w-full py-3 px-4 bg-red-600 text-white font-semibold rounded-lg hover:bg-red-700 transition-colors duration-200">
                                Yes, Cancel Transaction
                            </button>
                            <button onclick="closeCancelTransactionModal()"
                                class="w-full py-3 px-4 bg-gray-600 text-white font-semibold rounded-lg hover:bg-gray-700 transition-colors duration-200">
                                Keep Transaction
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Cancel Confirmation Modal -->
            <div id="cancel-confirmation-modal"
                class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
                <div class="bg-white dark:bg-gray-800 rounded-2xl p-8 max-w-sm w-full mx-4 text-center">
                    <div class="mb-6">
                        <div
                            class="w-20 h-20 bg-green-100 dark:bg-green-900/20 rounded-full flex items-center justify-center mx-auto mb-4">
                            <span class="text-4xl">✅</span>
                        </div>
                        <h3 class="text-xl font-bold text-green-600 dark:text-green-400 mb-4">
                            Transaction Cancelled!
                        </h3>
                        <p class="text-sm text-gray-600 dark:text-gray-300 mb-6">
                            Your transaction has been successfully cancelled. The refund of <strong>RM <span
                                    id="refund-amount">0.00</span></strong> will be processed within 3-5 business days.
                        </p>

                        <div class="space-y-3">
                            <button onclick="proceedToHome()"
                                class="w-full py-3 px-4 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 transition-colors duration-200">
                                Return to Home
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Charging Complete Modal -->
            <div id="complete-modal"
                class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
                <div class="bg-white dark:bg-gray-800 rounded-2xl p-8 max-w-sm w-full mx-4 text-center">
                    <div class="mb-6">
                        <div
                            class="w-20 h-20 bg-green-100 dark:bg-green-900/20 rounded-full flex items-center justify-center mx-auto mb-4">
                            <span class="text-4xl text-white"><svg xmlns="http://www.w3.org/2000/svg" width="24"
                                    height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                                    stroke-linecap="round" stroke-linejoin="round"
                                    class="lucide lucide-battery-charging-icon lucide-battery-charging">
                                    <path d="m11 7-3 5h4l-3 5" />
                                    <path d="M14.856 6H16a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2h-2.935" />
                                    <path d="M22 14v-4" />
                                    <path d="M5.14 18H4a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h2.936" />
                                </svg></span>
                        </div>
                        <h3 class="text-2xl font-bold text-green-600 dark:text-green-400 mb-2">
                            Charging Complete!
                        </h3>
                        <p class="text-sm text-gray-600 dark:text-gray-300 mb-6">
                            Your vehicle has been successfully charged.
                        </p>

                        <!-- Receipt Options -->
                        <div class="space-y-4">
                            <div class="space-y-3">
                                <button onclick="sendWhatsAppReceipt()"
                                    class="w-full py-3 px-4 bg-green-600 text-white font-semibold rounded-lg hover:bg-green-700 transition-colors duration-200 flex items-center justify-center gap-2">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24"
                                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                        stroke-linejoin="round"
                                        class="lucide lucide-message-circle-icon lucide-message-circle">
                                        <path
                                            d="M2.992 16.342a2 2 0 0 1 .094 1.167l-1.065 3.29a1 1 0 0 0 1.236 1.168l3.413-.998a2 2 0 0 1 1.099.092 10 10 0 1 0-4.777-4.719" />
                                    </svg>
                                    Send via WhatsApp
                                </button>

                                <button onclick="downloadPDFReceipt()"
                                    class="w-full py-3 px-4 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 transition-colors duration-200 flex items-center justify-center gap-2">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24"
                                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                        stroke-linejoin="round" class="lucide lucide-file-down-icon lucide-file-down">
                                        <path d="M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7Z" />
                                        <path d="M14 2v4a2 2 0 0 0 2 2h4" />
                                        <path d="M12 18v-6" />
                                        <path d="m9 15 3 3 3-3" />
                                    </svg>
                                    Download PDF Receipt
                                </button>

                                <button onclick="finishSession()"
                                    class="w-full py-3 px-4 bg-gray-600 text-white font-semibold rounded-lg hover:bg-gray-700 transition-colors duration-200 flex items-center justify-center gap-2">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24"
                                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                        stroke-linejoin="round"
                                        class="lucide lucide-circle-check-icon lucide-circle-check">
                                        <circle cx="12" cy="12" r="10" />
                                        <path d="m9 12 2 2 4-4" />
                                    </svg>
                                    Finish Session
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Receipt Downloaded Modal -->
            <div id="receipt-downloaded-modal"
                class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
                <div class="bg-white dark:bg-gray-800 rounded-2xl p-8 max-w-sm w-full mx-4 text-center">
                    <div class="mb-6">
                        <div
                            class="w-20 h-20 bg-blue-100 dark:bg-blue-900/20 rounded-full flex items-center justify-center mx-auto mb-4">
                            <span class="text-4xl">📄</span>
                        </div>
                        <h3 class="text-xl font-bold text-blue-600 dark:text-blue-400 mb-4">
                            Receipt Downloaded!
                        </h3>
                        <p class="text-sm text-gray-600 dark:text-gray-300 mb-6">
                            Your receipt has been successfully downloaded and saved to your device.
                        </p>

                        <div class="space-y-3">
                            <button onclick="openReceiptPage()"
                                class="w-full py-3 px-4 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 transition-colors duration-200 flex items-center justify-center gap-2">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24"
                                    fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                    stroke-linejoin="round" class="lucide lucide-external-link">
                                    <path d="M15 3h6v6" />
                                    <path d="M10 14 21 3" />
                                    <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6" />
                                </svg>
                                View Receipt
                            </button>
                            <button onclick="closeReceiptDownloadedModal()"
                                class="w-full py-3 px-4 bg-gray-600 text-white font-semibold rounded-lg hover:bg-gray-700 transition-colors duration-200">
                                Close
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Back Button -->
            <div class="text-center">
                <button onclick="goBackToHome()"
                    class="text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-gray-200 text-sm font-medium transition-colors duration-200">
                    ← Back to Home
                </button>
            </div>

            <!-- Debugger Button -->
            <div class="text-center mt-4">
                <button id="debugger-btn" onclick="openDebugger()"
                    class="px-6 py-3 bg-red-600 text-white border border-red-700 rounded-lg shadow-lg hover:shadow-xl hover:bg-red-700 transition-all duration-300 text-sm font-medium flex items-center justify-center gap-2 mx-auto">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                        class="lucide lucide-bug-play-icon lucide-bug-play">
                        <path d="M10 19.655A6 6 0 0 1 6 14v-3a4 4 0 0 1 4-4h4a4 4 0 0 1 4 3.97" />
                        <path
                            d="M14 15.003a1 1 0 0 1 1.517-.859l4.997 2.997a1 1 0 0 1 0 1.718l-4.997 2.997a1 1 0 0 1-1.517-.86z" />
                        <path d="M14.12 3.88 16 2" />
                        <path d="M20.97 5c0 2.1-1.6 3.8-3.5 4" />
                        <path d="M3 21c0-2.1 1.7-3.9 3.8-4" />
                        <path d="M6 13H2" />
                        <path d="M6.53 9C4.6 8.8 3 7.1 3 5" />
                        <path d="m8 2 1.88 1.88" />
                        <path d="M9 7.13v-1a3 3 0 0 1 4.18-2.895 3 3 0 0 1 1.821 2.896v1" />
                    </svg>
                    Developer Debug Tools
                </button>
            </div>
        </div>
    </div>

    <!-- JavaScript -->
    <script src="script.js"></script>
    <script>
        let chargerId = '';
        let amount = 0;
        let totalTimeMinutes = 0;
        let remainingTimeSeconds = 0;
        let chargingTimer = null;
        let isPluggedIn = false;
        let isCharging = false;
        let isCompleted = false;
        let chargerConnected = true; // Track debugger toggle state - DEFAULT TO TRUE

        // Initialize active charging page
        function initializeActivePage() {
            chargerId = getChargerIdFromURL();
            amount = parseFloat(getAmountFromURL()) || 0;

            if (chargerId && amount > 0) {
                document.getElementById('active-charger-id').textContent = chargerId.toUpperCase();
                document.getElementById('active-amount').textContent = `RM ${amount.toFixed(2)}`;

                // Calculate charging time (Fixed 15 seconds)
                totalTimeMinutes = 0.25; // 15 seconds = 0.25 minutes
                remainingTimeSeconds = 15;

                updateTimeDisplay();
                updateChargingStatus('waiting');
                updateConnectionStatus(false);

                // Set total duration (Fixed 15 seconds)
                const totalTimeString = "00:15";
                document.getElementById('total-duration').textContent = totalTimeString;

                // Initialize debugger toggle to default state (connected)
                initializeDebuggerToggle();
            } else {
                // Redirect back if missing parameters
                window.location.href = 'index.html';
            }
        }

        // Initialize debugger toggle to default state
        function initializeDebuggerToggle() {
            if (chargerConnected) {
                const toggle = document.getElementById('charger-toggle');
                const circle = document.getElementById('toggle-circle');

                // Set toggle to connected state
                toggle.classList.remove('bg-gray-200', 'dark:bg-gray-600');
                toggle.classList.add('bg-blue-600');
                circle.classList.remove('translate-x-1');
                circle.classList.add('translate-x-6');

                // Auto-connect when toggle is on by default
                isPluggedIn = true;
                updateChargingStatus('ready');
                updateConnectionStatus(true);

                // Hide plugin controls and show charging controls
                document.getElementById('simulation-controls').classList.add('hidden');
                document.getElementById('charging-controls').classList.remove('hidden');
            }
        }

        // Update time display
        function updateTimeDisplay() {
            const minutes = Math.floor(remainingTimeSeconds / 60);
            const seconds = remainingTimeSeconds % 60;
            const timeString = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            document.getElementById('circular-timer').textContent = timeString;

            // Update progress bar
            updateProgressBar();
        }

        // Update progress bar
        function updateProgressBar() {
            const totalSeconds = 15; // Fixed 15 seconds total
            const progress = ((totalSeconds - remainingTimeSeconds) / totalSeconds) * 100;

            const progressBar = document.getElementById('progress-bar');
            const progressPercentage = document.getElementById('progress-percentage');

            if (isCharging) {
                progressBar.style.width = `${progress}%`;
                progressPercentage.textContent = `${Math.round(progress)}%`;
            } else {
                progressBar.style.width = '0%';
                progressPercentage.textContent = '0%';
            }
        }

        // Update connection status
        function updateConnectionStatus(connected) {
            const statusElement = document.getElementById('car-connection-status');

            if (connected) {
                statusElement.innerHTML = '<span class="w-1.5 h-1.5 bg-green-500 rounded-full mr-1.5"></span>Connected';
                statusElement.className = 'inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200';
            } else {
                statusElement.innerHTML = '<span class="w-1.5 h-1.5 bg-red-500 rounded-full mr-1.5"></span>Not Connected';
                statusElement.className = 'inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200';
            }
        }

        // Toggle charger connection (debugger)
        function toggleChargerConnection() {
            chargerConnected = !chargerConnected;

            const toggle = document.getElementById('charger-toggle');
            const circle = document.getElementById('toggle-circle');

            if (chargerConnected) {
                toggle.classList.remove('bg-gray-200', 'dark:bg-gray-600');
                toggle.classList.add('bg-blue-600');
                circle.classList.remove('translate-x-1');
                circle.classList.add('translate-x-6');

                // Auto-connect when toggle is turned on
                isPluggedIn = true;
                updateChargingStatus('ready');
                updateConnectionStatus(true);

                // Hide plugin controls and show charging controls
                document.getElementById('simulation-controls').classList.add('hidden');
                document.getElementById('charging-controls').classList.remove('hidden');
            } else {
                toggle.classList.remove('bg-blue-600');
                toggle.classList.add('bg-gray-200', 'dark:bg-gray-600');
                circle.classList.remove('translate-x-6');
                circle.classList.add('translate-x-1');

                // Auto-disconnect when toggle is turned off
                isPluggedIn = false;
                updateChargingStatus('waiting');
                updateConnectionStatus(false);

                // Show plugin controls and hide charging controls
                document.getElementById('simulation-controls').classList.remove('hidden');
                document.getElementById('charging-controls').classList.add('hidden');

                // Stop charging if in progress
                if (isCharging) {
                    stopCharging();
                }
            }
        }

        // Update charging status
        function updateChargingStatus(status) {
            const statusElement = document.getElementById('main-charging-status');

            switch (status) {
                case 'waiting':
                    statusElement.innerHTML = '<span class="w-1.5 h-1.5 bg-yellow-500 rounded-full mr-1.5"></span>Waiting';
                    statusElement.className = 'inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-200';
                    break;
                case 'ready':
                    statusElement.innerHTML = '<span class="w-1.5 h-1.5 bg-blue-500 rounded-full mr-1.5"></span>Ready';
                    statusElement.className = 'inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200';
                    break;
                case 'charging':
                    statusElement.innerHTML = '<span class="w-1.5 h-1.5 bg-green-500 rounded-full mr-1.5 animate-pulse"></span>Charging';
                    statusElement.className = 'inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200';
                    break;
                case 'completed':
                    statusElement.innerHTML = '<span class="w-1.5 h-1.5 bg-gray-500 rounded-full mr-1.5"></span>Completed';
                    statusElement.className = 'inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800 dark:bg-gray-900 dark:text-gray-200';
                    break;
            }
        }

        // Open debugger modal
        function openDebugger() {
            document.getElementById('debugger-modal').classList.remove('hidden');
        }

        // Close debugger modal
        function closeDebuggerModal() {
            document.getElementById('debugger-modal').classList.add('hidden');
        }

        // Complete charge simulate (from debugger)
        function completeChargeSimulate() {
            closeDebuggerModal();
            remainingTimeSeconds = 0;
            updateTimeDisplay();
            completeCharging();
        }

        // Simulate plug-in
        function simulatePlugIn() {
            // Always show the plugin modal, regardless of debugger toggle
            openPluginModal();
        }        // Actually perform plug-in connection
        function actuallyPlugIn() {
            isPluggedIn = true;
            updateChargingStatus('ready');
            updateConnectionStatus(true);

            // Hide plugin controls and show charging controls
            document.getElementById('simulation-controls').classList.add('hidden');
            document.getElementById('charging-controls').classList.remove('hidden');
        }

        // Start charging
        function startCharging() {
            if (!isPluggedIn) return;

            isCharging = true;
            updateChargingStatus('charging');

            // Enable stop button
            const stopBtn = document.getElementById('stop-charging-btn');
            stopBtn.disabled = false;
            stopBtn.classList.remove('bg-gray-300', 'dark:bg-gray-600', 'text-gray-500', 'dark:text-gray-400', 'cursor-not-allowed');
            stopBtn.classList.add('bg-red-600', 'text-white', 'hover:bg-red-700', 'cursor-pointer');

            // Disable start button
            const startBtn = document.getElementById('start-charging-btn');
            startBtn.disabled = true;
            startBtn.classList.remove('bg-green-600', 'text-white', 'hover:bg-green-700', 'cursor-pointer');
            startBtn.classList.add('bg-gray-300', 'dark:bg-gray-600', 'text-gray-500', 'dark:text-gray-400', 'cursor-not-allowed');

            // Start countdown timer
            chargingTimer = setInterval(() => {
                remainingTimeSeconds--;
                updateTimeDisplay();

                if (remainingTimeSeconds <= 0) {
                    completeCharging();
                }
            }, 1000);
        }

        // Stop charging
        function stopCharging() {
            // This function is now just called directly by confirmStopCharging
            completeCharging();
        }

        // Show stop charging modal
        function showStopChargingModal() {
            if (!isCharging) return;
            document.getElementById('stop-charging-modal').classList.remove('hidden');
        }

        // Close stop charging modal
        function closeStopChargingModal() {
            document.getElementById('stop-charging-modal').classList.add('hidden');
        }

        // Confirm stop charging
        function confirmStopCharging() {
            closeStopChargingModal();
            stopCharging();
        }

        // Show cancel transaction modal
        function showCancelTransactionModal() {
            // Update the amount in the modal
            document.getElementById('cancel-amount').textContent = amount.toFixed(2);
            document.getElementById('cancel-transaction-modal').classList.remove('hidden');
        }

        // Close cancel transaction modal
        function closeCancelTransactionModal() {
            document.getElementById('cancel-transaction-modal').classList.add('hidden');
        }

        // Confirm cancel transaction
        function confirmCancelTransaction() {
            closeCancelTransactionModal();

            // Update refund amount in confirmation modal
            document.getElementById('refund-amount').textContent = amount.toFixed(2);

            // Show confirmation modal
            document.getElementById('cancel-confirmation-modal').classList.remove('hidden');
        }

        // Proceed to home after cancellation confirmation
        function proceedToHome() {
            window.location.href = 'index.html';
        }

        // Complete charging
        function completeCharging() {
            isCharging = false;
            isCompleted = true;

            if (chargingTimer) {
                clearInterval(chargingTimer);
                chargingTimer = null;
            }

            updateChargingStatus('completed');

            // Disable all charging controls
            const startBtn = document.getElementById('start-charging-btn');
            const stopBtn = document.getElementById('stop-charging-btn');

            startBtn.disabled = true;
            stopBtn.disabled = true;

            startBtn.classList.remove('bg-green-600', 'text-white', 'hover:bg-green-700', 'cursor-pointer');
            startBtn.classList.add('bg-gray-300', 'dark:bg-gray-600', 'text-gray-500', 'dark:text-gray-400', 'cursor-not-allowed');

            stopBtn.classList.remove('bg-red-600', 'text-white', 'hover:bg-red-700', 'cursor-pointer');
            stopBtn.classList.add('bg-gray-300', 'dark:bg-gray-600', 'text-gray-500', 'dark:text-gray-400', 'cursor-not-allowed');

            // Show charging complete modal with celebration effects
            document.getElementById('complete-modal').classList.remove('hidden');

            // Play celebration effects
            playCelebrationEffects();
        }

        // Play celebration effects
        function playCelebrationEffects() {
            // Play chime sound
            try {
                const audio = new Audio('Sounds/Chime.MP3');
                audio.play().catch(e => console.log('Audio play failed:', e));
            } catch (e) {
                console.log('Audio creation failed:', e);
            }

            // Vibrate phone (if supported)
            if (navigator.vibrate) {
                navigator.vibrate([200, 100, 200, 100, 200]);
            }

            // Create confetti effect
            createConfetti();
        }

        // Create confetti effect
        function createConfetti() {
            const colors = ['#3B82F6', '#10B981', '#F59E0B', '#EF4444', '#8B5CF6', '#06B6D4'];
            const confettiContainer = document.createElement('div');
            confettiContainer.id = 'confetti-container';
            confettiContainer.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                pointer-events: none;
                z-index: 9999;
                overflow: hidden;
            `;
            document.body.appendChild(confettiContainer);

            // Create multiple confetti pieces
            for (let i = 0; i < 60; i++) {
                const confetti = document.createElement('div');
                const color = colors[Math.floor(Math.random() * colors.length)];
                const startX = Math.random() * 100; // Use percentage
                const delay = Math.random() * 1; // Random delay up to 1s
                const duration = 2 + Math.random() * 2; // 2-4 seconds duration
                const rotation = Math.random() * 360; // Random initial rotation

                confetti.style.cssText = `
                    position: absolute;
                    width: 8px;
                    height: 8px;
                    background-color: ${color};
                    left: ${startX}%;
                    top: -20px;
                    border-radius: 2px;
                    animation: confetti-fall ${duration}s ease-in ${delay}s forwards;
                    transform: rotate(${rotation}deg);
                `;

                confettiContainer.appendChild(confetti);
            }

            // Add CSS animation for confetti
            if (!document.getElementById('confetti-style')) {
                const style = document.createElement('style');
                style.id = 'confetti-style';
                style.textContent = `
                    @keyframes confetti-fall {
                        0% {
                            transform: translateY(0) rotate(0deg) scale(1);
                            opacity: 1;
                        }
                        50% {
                            transform: translateY(50vh) rotate(180deg) scale(0.8);
                            opacity: 0.8;
                        }
                        100% {
                            transform: translateY(100vh) rotate(360deg) scale(0.6);
                            opacity: 0;
                        }
                    }
                `;
                document.head.appendChild(style);
            }

            // Clean up confetti after animation
            setTimeout(() => {
                if (confettiContainer && confettiContainer.parentNode) {
                    confettiContainer.parentNode.removeChild(confettiContainer);
                }
            }, 5000); // Increased cleanup time
        }

        // Open plugin modal
        function openPluginModal() {
            document.getElementById('plugin-modal').classList.remove('hidden');
        }

        // Close plugin modal
        function closePluginModal() {
            document.getElementById('plugin-modal').classList.add('hidden');
            // Only connect if debugger toggle is on
            if (chargerConnected) {
                actuallyPlugIn();
            }
        }

        // Actually perform plug-in connection
        function actuallyPlugIn() {
            isPluggedIn = true;
            updateChargingStatus('ready');
            updateConnectionStatus(true);

            // Hide plugin controls and show charging controls
            document.getElementById('simulation-controls').classList.add('hidden');
            document.getElementById('charging-controls').classList.remove('hidden');
        }

        // Send WhatsApp receipt (mock)
        function sendWhatsAppReceipt() {
            // Get phone number from localStorage (entered at the beginning)
            const phoneNumber = localStorage.getItem('userPhoneNumber');

            if (!phoneNumber || !phoneNumber.trim()) {
                alert('Phone number not found. Please restart the charging session.');
                return;
            }

            // Mock WhatsApp integration
            const message = `Kucharge Receipt\\n\\nCharger ID: ${chargerId.toUpperCase()}\\nAmount: RM ${amount.toFixed(2)}\\nDuration: ${totalTimeMinutes} minutes\\nStatus: Completed\\n\\nThank you for using Kucharge! ⚡`;
            const whatsappUrl = `https://wa.me/${phoneNumber.replace(/\D/g, '')}?text=${encodeURIComponent(message)}`;

            // Open WhatsApp in new tab
            window.open(whatsappUrl, '_blank');

            alert('Receipt sent via WhatsApp! 📱');
        }

        // Download PDF receipt (mock)
        function downloadPDFReceipt() {
            // Store receipt data for the receipt page
            const receiptData = {
                chargerId: chargerId.toUpperCase(),
                amount: amount.toFixed(2),
                duration: totalTimeMinutes,
                status: 'Completed',
                timestamp: new Date().toLocaleString(),
                transactionId: 'TXN' + Date.now(),
                location: 'Sheraton Hotel',
                chargerType: 'AC Type 2',
                powerDelivered: '22kW'
            };

            // Store in localStorage for receipt page
            localStorage.setItem('receiptData', JSON.stringify(receiptData));

            // Show receipt downloaded modal
            document.getElementById('receipt-downloaded-modal').classList.remove('hidden');
        }

        // Close receipt downloaded modal
        function closeReceiptDownloadedModal() {
            document.getElementById('receipt-downloaded-modal').classList.add('hidden');
        }

        // Open receipt page
        function openReceiptPage() {
            window.open('receipt.html', '_blank');
            closeReceiptDownloadedModal();
        }

        // Finish session
        function finishSession() {
            // Store session data for landing page
            localStorage.setItem('lastChargerId', chargerId);
            localStorage.setItem('lastChargeAmount', amount.toFixed(2));

            // Redirect to landing page
            window.location.href = 'landing.html';
        }

        // Go back to home
        function goBackToHome() {
            if (isCharging) {
                if (confirm('Charging is in progress. Are you sure you want to leave?')) {
                    if (chargingTimer) {
                        clearInterval(chargingTimer);
                    }
                    window.location.href = 'index.html';
                }
            } else {
                window.location.href = 'index.html';
            }
        }

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', initializeActivePage);
    </script>
</body>

</html>